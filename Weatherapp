import requests
import csv
import os
from datetime import datetime

APIK = "bcf25bba9109567dc5e917f71f95472f"  #API from OpenWeather Website
BASEURL = "http://api.openweathermap.org/data/2.5/weather"

Folder = "data"
File = os.path.join(Folder, "weather_hist.csv")
os.makedirs(Folder, exist_ok=True)

def get_weather(cityname): #gets the weather data from the website data
    param = {"q": cityname, "appid": APIK, "units": "metric"} #sets parameters
    response = requests.get(BASEURL,params=param)

    if response.status_code == 200: #connects varaibles with the data, if the city has been found
        data = response.json()
        city = data["name"]
        temp = data["main"]["temp"]
        condition = data["weather"][0]["description"]

        #prints data
        print(f"\n Weather in {city}:")
        print(f"\n temp.: {temp}°C")
        print(f" condition: {condition}")

        with open(File, "a", newline="") as f: #saves data, creates/opens data as writer
            writer = csv.writer(f)
            writer.writerow([datetime.now().strftime("%Y-%m-%d %H:%M:%S"),
                             city, temp, condition])
            
    else: #if no city has been found
        print(" city NOT FOUND, please try again")

def menu(): #Basic menu
    while True:
        print("\n -----Weather APP-----")
        print("(1). check weather")
        print("(2). view history")
        print("(3). exit")

        choice = input("choose an option (1-3): ")
        if choice == "1":
            c = input("Enter city name: ")
            get_weather(c)
        elif choice == "2":
            view_history()
        elif choice == "3":
            break
        else:
            print("invalid, try again")

def view_history(): #opens the csv file to check history
    try:
        with open(File, "r") as f: #opens data as reader
            reader = csv.reader(f)
            print("---History---")
            for row in reader: #formats data
                print(f"{row[0]} | {row[1]} | {row[2]}°C")
    except FileNotFoundError:
        print("No history")

if __name__ == "__main__": #runs the menu
    menu()